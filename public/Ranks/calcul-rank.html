<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcule ton rang - Performance athlétique</title>
  <link rel="stylesheet" href="./calcul-rank.css" />
</head>
<body>
  <div class="main-container">
    <div class="calculator-container">
      <div class="header">
        <h1>Calcule ton rang</h1>
        <p>Entre tes performances et obtiens ton rang</p>
      </div>

      <!-- NAVBAR -->
      <div class="tabs">
        <button class="tab active" data-tab="demi-fond">Demi-fond</button>
        <button class="tab" data-tab="sprint">Sprint</button>
        <button class="tab" data-tab="lancers">Lancers</button>
        <button class="tab" data-tab="sauts">Sauts</button>
      </div>

      <!-- DEMI-FOND -->
      <div id="demi-fond-content" class="tab-content active" data-tab="demi-fond">
        <form class="calculator-form" id="demi-fond-form" novalidate>
          <div class="form-grid">
            <div class="form-group">
              <label>800m (hh:mm:ss ou mm:ss)</label>
              <input class="form-input time-input" id="chrono_800" placeholder="02:20">
            </div>
            <div class="form-group">
              <label>1500m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_1500" placeholder="04:20">
            </div>
            <div class="form-group">
              <label>3000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_3000" placeholder="09:00">
            </div>
            <div class="form-group">
              <label>5000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_5000" placeholder="15:55">
            </div>
            <div class="form-group">
              <label>10 000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_10000" placeholder="45:00">
            </div>
            <div class="form-group">
              <label>Semi-marathon (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_semi" placeholder="02:00:00">
            </div>
            <div class="form-group">
              <label>Marathon (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_marathon" placeholder="04:03:10">
            </div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- SPRINT -->
      <div id="sprint-content" class="tab-content" data-tab="sprint">
        <form class="calculator-form" id="sprint-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>50m (ss:ms)</label>   <input class="form-input sprint-input" id="t50"   placeholder="06:20"></div>
            <div class="form-group"><label>60m (ss:ms)</label>   <input class="form-input sprint-input" id="t60"   placeholder="07:20"></div>
            <div class="form-group"><label>100m (ss:ms)</label>  <input class="form-input sprint-input" id="t100"  placeholder="10:52"></div>
            <div class="form-group"><label>200m (ss:ms)</label>  <input class="form-input sprint-input" id="t200"  placeholder="21:20"></div>
            <div class="form-group"><label>400m (ss:ms)</label>  <input class="form-input sprint-input" id="t400"  placeholder="47:50"></div>
            <div class="form-group"><label>50m Haies (ss:ms)</label> <input class="form-input sprint-input" id="t50h"  placeholder="06:90"></div>
            <div class="form-group"><label>60m Haies (ss:ms)</label> <input class="form-input sprint-input" id="t60h"  placeholder="08:20"></div>
            <div class="form-group"><label>110m Haies (ss:ms)</label><input class="form-input sprint-input" id="t110h" placeholder="13:50"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- LANCERS -->
      <div id="lancers-content" class="tab-content" data-tab="lancers">
        <form class="calculator-form" id="lancers-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>Poids (m)</label>   <input class="form-input meter-input" id="poids"   placeholder="14,72"></div>
            <div class="form-group"><label>Disque (m)</label>  <input class="form-input meter-input" id="disque"  placeholder="55,30"></div>
            <div class="form-group"><label>Marteau (m)</label> <input class="form-input meter-input" id="marteau" placeholder="72,00"></div>
            <div class="form-group"><label>Javelot (m)</label> <input class="form-input meter-input" id="javelot" placeholder="69,50"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- SAUTS -->
      <div id="sauts-content" class="tab-content" data-tab="sauts">
        <form class="calculator-form" id="sauts-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>Hauteur (m)</label>  <input class="form-input meter-input" id="hauteur"  placeholder="1,90"></div>
            <div class="form-group"><label>Perche (m)</label>   <input class="form-input meter-input" id="perche"   placeholder="5,10"></div>
            <div class="form-group"><label>Longueur (m)</label> <input class="form-input meter-input" id="longueur" placeholder="6,42"></div>
            <div class="form-group"><label>Triple (m)</label>   <input class="form-input meter-input" id="triple"   placeholder="13,80"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>
    </div>

    <div class="results-container">
      <div class="results-header">
        <h2>Tes rangs</h2>
        <p>Analyse de performance pour chaque épreuve</p>
      </div>
      <div class="rank-grid" id="rankGrid">
        <p class="empty-state">Entre tes performances et calcule ton rang</p>
      </div>
    </div>
  </div>

  <script>
    /* ========= Communication avec le parent (profile.jsx) ========= */
    let __lastSentHeight = 0;
    let __heightTimer = null;

    function __measureHeight() {
      const h1 = document.documentElement.scrollHeight || 0;
      const h2 = document.body.scrollHeight || 0;
      return Math.max(h1, h2, 0);
    }

    function postHeight(force = false) {
      const h = __measureHeight();
      if (!force && Math.abs(h - __lastSentHeight) < 8) return; // évite les micro-variations
      __lastSentHeight = h;
      window.parent?.postMessage({ type: "ranks:height", height: h }, "*");
    }
    function schedulePostHeight(force = false) {
      if (__heightTimer) clearTimeout(__heightTimer);
      __heightTimer = setTimeout(() => postHeight(force), 80); // léger debounce
    }

    function sendRanksToParent(ranks) {
      if (!ranks || !Object.keys(ranks).length) return;
      window.parent?.postMessage({ type: "ranks:result", ranks }, "*");
    }
    function postIframeHeight(extra = 60) {
      const h = Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight
      );
      window.parent?.postMessage({ type: "ranks:height", height: h + extra }, "*");
    }

    // … dans ton handler “Calculer” :
    function onCalculerClick() {
      const ranks = computeRanks(); // <- ton calcul existant

      // 1) on envoie les résultats (tu fais probablement déjà ça)
      window.parent?.postMessage({ type: "ranks:result", ranks }, "*");

      // 2) on pousse la hauteur UNE FOIS (simple et suffisant ici)
      postIframeHeight(60);
    }


    window.addEventListener("message", (e) => {
      if (e?.data?.type === "ranks:export" && window.__lastRanks) {
        sendRanksToParent(window.__lastRanks);
      }
    });

    // MutationObserver pour détecter les changements de contenu
    const mo = new MutationObserver(() => schedulePostHeight(false));
    mo.observe(document.body, { childList: true, subtree: true, attributes: true });

    window.addEventListener("load", () => schedulePostHeight(true));
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => schedulePostHeight(true)).catch(() => {});
    }

    /* ================== Tabs ================== */
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(`${t.dataset.tab}-content`).classList.add('active');
        schedulePostHeight(true);
      });
    });

    const rankGrid = document.getElementById('rankGrid');

    // Noms lisibles (utilisés dans l’objet transmis au parent)
    const NAMES = {
      'demi-fond': {
        '800':'800m','1500':'1500m','3000':'3000m','5000':'5000m',
        '10000':'10 000m','semi':'Semi-marathon','marathon':'Marathon'
      },
      'sprint': {
        t50:'50m', t60:'60m', t100:'100m', t200:'200m', t400:'400m',
        t50h:'50m H', t60h:'60m H', t110h:'110m H'
      },
      'lancers': { poids:'Poids', disque:'Disque', marteau:'Marteau', javelot:'Javelot' },
      'sauts':   { hauteur:'Hauteur', perche:'Perche', longueur:'Longueur', triple:'Triple saut' }
    };

    /* ================== Masques d’entrée ================== */
    document.querySelectorAll('.time-input').forEach(input => {
      input.addEventListener('input', e => {
        let v = e.target.value.replace(/[^\d]/g, '');
        if (v.length > 2 && v.length <= 4) v = v.slice(0,2) + ':' + v.slice(2);
        else if (v.length > 4) v = v.slice(0,2) + ':' + v.slice(2,4) + ':' + v.slice(4,6);
        e.target.value = v;
      });
    });
    document.querySelectorAll('.sprint-input').forEach(input => {
      input.addEventListener('input', e => {
        let v = e.target.value.replace(/[^\d]/g,'');
        if (v.length > 2) v = v.slice(0,2) + ':' + v.slice(2,4);
        e.target.value = v;
      });
    });

    /* ================== Validations ================== */
    function isValidTime(str){ return /^\d{1,2}:\d{2}$/.test(str) || /^\d{1,2}:\d{2}:\d{2}$/.test(str); }
    function isValidSprint(str){ return /^\d{1,2}:\d{1,3}$/.test(str) || /^\d{1,2}([.,]\d{1,3})?$/.test(str); }
    function isValidMeters(str){ return /^\d+([.,]\d+)?$/.test(str.trim()); }

    /* ================== Soumission ================== */
    document.querySelectorAll('.calculator-form').forEach(form => {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const tab = document.querySelector('.tab.active').dataset.tab;
        await calculate(tab);
      });
    });

    async function calculate(tab){
      const form = document.getElementById(`${tab}-form`);
      const inputs = form.querySelectorAll('.form-input');
      const payload = {};
      let ok = true, hasAny = false;

      inputs.forEach(inp => {
        inp.classList.remove('input-error');
        const v = inp.value.trim();
        if (v==='') return;
        let valid = false;

        if (tab==='demi-fond') valid = isValidTime(v);
        else if (tab==='sprint') valid = isValidSprint(v);
        else valid = isValidMeters(v); // lancers & sauts

        if (!valid) { inp.classList.add('input-error'); ok=false; }
        else { payload[inp.id] = v; hasAny = true; }
      });

      if (!ok){
        rankGrid.innerHTML = '<p class="empty-state error-message">Formats invalides. Utilise hh:mm:ss (demi-fond), ss:ms (sprint), mètres (lancers/sauts).</p>';
        schedulePostHeight(false);
        return;
      }
      if (!hasAny){
        rankGrid.innerHTML = '<p class="empty-state">Renseigne au moins une performance.</p>';
        schedulePostHeight(false);
        return;
      }

      rankGrid.innerHTML = '<p class="empty-state">Calcul en cours…</p>';
      schedulePostHeight(false);

      try {
        const res = await fetch(`https://api-front.riseupmotion.com/calcul/${tab}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        renderResults(tab, data, payload);
      } catch(err){
        console.error(err);
        rankGrid.innerHTML = '<p class="empty-state error-message">Erreur : impossible de joindre le serveur.</p>';
        schedulePostHeight(false);
      }
    }

    function renderResults(tab, data, payload){
      rankGrid.innerHTML = '';
      if (!data.success || !data.results){
        rankGrid.innerHTML = `<p class="empty-state error-message">${data.message || 'Erreur inconnue.'}</p>`;
        schedulePostHeight(false);
        return;
      }

      const ranks = {};

      // Parcours des champs soumis pour garder l’ordre d’entrée
      Object.keys(payload).forEach(id => {
        const keyForResults = (tab==='demi-fond') ? id.replace('chrono_','') : id; // le backend demi-fond renvoie sans "chrono_"
        const res = data.results[keyForResults];
        const label = NAMES[tab][keyForResults] || keyForResults;
        const value = payload[id];

        let badge = '<div class="rank-badge rank-empty">-</div>', cls='rank-card';
        if (res){
          const style = res.hex ? `style="background:${res.hex}"` : '';
          badge = `<div class="rank-badge" ${style}>${res.rang}</div>`;
          cls = 'rank-card filled';

          // Alimente l’objet envoyé au parent
          ranks[label] = { rank: String(res.rang), performance: String(value) };
        }

        rankGrid.insertAdjacentHTML('beforeend', `
          <div class="${cls}">
            <div class="event-info">
              <div class="event-name">${label}</div>
              <div class="performance-value">${value}</div>
            </div>
            ${badge}
          </div>
        `);
      });

      window.__lastRanks = ranks;
      sendRanksToParent(ranks);
      schedulePostHeight(true);
    }
  </script>
</body>
</html>
