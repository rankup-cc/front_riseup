<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcule ton rang - Performance athlétique</title>
  <style>
    /* ton CSS d’origine + quelques ajouts mineurs */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system, BlinkMacSystemFont,'Segoe UI', Roboto, sans-serif;
      background:linear-gradient(135deg,#f0f4f8 0%,#e2e8f0 100%);
      min-height:100vh; padding:20px;
    }
    .main-container {
      max-width:1200px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr;
      gap:30px; align-items:start;
    }
    .calculator-container,.results-container {
      background:#fff; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.1); padding:40px;
    }
    .header { text-align:center; margin-bottom:30px; }
    .header h1 { font-size:2.2rem; font-weight:700; color:#213A57; margin-bottom:10px; }
    .header p  { color:#0AD1C8; font-size:1.1rem; line-height:1.5; }

    .tabs { display:flex; border-bottom:2px solid #e2e8f0; margin-bottom:30px; gap:0; }
    .tab {
      flex:1; padding:12px 20px; background:none; border:none; font-size:1rem; font-weight:500;
      color:#213A57; cursor:pointer; transition:.3s; border-bottom:3px solid transparent;
    }
    .tab.active { color:#4a5568; border-bottom-color:#4a5568; font-weight:600; }
    .tab:hover { color:#4a5568; background:#f7fafc; }

    .form-grid { display:grid; grid-template-columns:1fr; gap:20px; margin-bottom:30px; }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-weight:500; color:#4a5568; margin-bottom:8px; font-size:.95rem; }
    .form-input {
      padding:14px 16px; border:2px solid #e2e8f0; border-radius:10px; font-size:1rem;
      transition:.3s; background:#fafafa;
    }
    .form-input:focus { outline:none; border-color:#4a5568; background:#fff; box-shadow:0 0 0 3px rgba(74,85,104,.1); }
    .form-input::placeholder { color:#a0aec0; font-weight:400; }
    .form-input.input-error { border-color:#e53e3e; background:#fff5f5; }

    .calculate-btn {
      background:#0AD1C8; color:#fff; border:none; padding:16px 32px; border-radius:25px;
      font-size:1.1rem; font-weight:600; cursor:pointer; transition:.3s; display:flex; align-items:center; justify-content:center;
      gap:8px; margin:0 auto; min-width:200px; width:100%;
    }
    .calculate-btn:hover { background:#213A57; transform:translateY(-2px); box-shadow:0 8px 20px rgba(74,85,104,.3); }

    .results-header { text-align:center; margin-bottom:30px; }
    .results-header h2 { font-size:2rem; font-weight:700; color:#213A57; margin-bottom:10px; }
    .results-header p  { color:#0AD1C8; font-size:1rem; }

    .rank-grid { display:grid; grid-template-columns:1fr; gap:15px; margin-bottom:25px; }
    .rank-card {
      background:linear-gradient(135deg,#f7fafc 0%,#edf2f7 100%); border-radius:12px; padding:20px;
      display:flex; align-items:center; justify-content:space-between; border:1px solid #e2e8f0;
      transition:.3s; opacity:.8; position:relative;
    }
    .rank-card.filled { opacity:1; background:#fff; transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.08); }
    .rank-card.filled::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#213A57; border-radius:12px 0 0 12px; }

    .event-info { display:flex; flex-direction:column; }
    .event-name { font-size:1rem; color:#0AD1C8; font-weight:600; margin-bottom:5px; }
    .performance-value { font-size:1.1rem; color:#2d3748; font-weight:700; }

    .rank-badge { display:inline-flex; align-items:center; justify-content:center; min-width:45px; height:45px; padding:0 10px; border-radius:22.5px; font-size:1.2rem; font-weight:700; color:#fff; }
    .rank-empty { background:#e2e8f0; color:#a0aec0; }

    .empty-state { text-align:center; color:#718096; font-style:italic; margin-top:50px; padding:20px; }
    .error-message { color:#c53030; font-weight:500; }

    @media (max-width:1024px) { .main-container { grid-template-columns:1fr; gap:25px; } }

    .tab-content { display:none; animation:fadeIn .3s ease-in-out; }
    .tab-content.active { display:block; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="calculator-container">
      <div class="header">
        <h1>Calcule ton rang</h1>
        <p>Entre tes performances et obtiens ton rang</p>
      </div>

      <!-- NAVBAR -->
      <div class="tabs">
        <button class="tab active" data-tab="demi-fond">Demi-fond</button>
        <button class="tab" data-tab="sprint">Sprint</button>
        <button class="tab" data-tab="lancers">Lancers</button>
        <button class="tab" data-tab="sauts">Sauts</button>
      </div>

      <!-- DEMI-FOND -->
      <div id="demi-fond-content" class="tab-content active" data-tab="demi-fond">
        <form class="calculator-form" id="demi-fond-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>800m (hh:mm:ss ou mm:ss)</label>
              <input class="form-input time-input" id="chrono_800" placeholder="02:20"></div>
            <div class="form-group"><label>1500m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_1500" placeholder="04:20"></div>
            <div class="form-group"><label>3000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_3000" placeholder="09:00"></div>
            <div class="form-group"><label>5000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_5000" placeholder="15:55"></div>
            <div class="form-group"><label>10 000m (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_10000" placeholder="45:00"></div>
            <div class="form-group"><label>Semi-marathon (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_semi" placeholder="02:00:00"></div>
            <div class="form-group"><label>Marathon (hh:mm:ss)</label>
              <input class="form-input time-input" id="chrono_marathon" placeholder="04:03:10"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- SPRINT -->
      <div id="sprint-content" class="tab-content" data-tab="sprint">
        <form class="calculator-form" id="sprint-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>50m (ss:ms)</label>   <input class="form-input sprint-input" id="t50"   placeholder="06:20"></div>
            <div class="form-group"><label>60m (ss:ms)</label>   <input class="form-input sprint-input" id="t60"   placeholder="07:20"></div>
            <div class="form-group"><label>100m (ss:ms)</label>  <input class="form-input sprint-input" id="t100"  placeholder="10:52"></div>
            <div class="form-group"><label>200m (ss:ms)</label>  <input class="form-input sprint-input" id="t200"  placeholder="21:20"></div>
            <div class="form-group"><label>400m (ss:ms)</label>  <input class="form-input sprint-input" id="t400"  placeholder="47:50"></div>
            <div class="form-group"><label>50m Haies (ss:ms)</label> <input class="form-input sprint-input" id="t50h"  placeholder="06:90"></div>
            <div class="form-group"><label>60m Haies (ss:ms)</label> <input class="form-input sprint-input" id="t60h"  placeholder="08:20"></div>
            <div class="form-group"><label>110m Haies (ss:ms)</label><input class="form-input sprint-input" id="t110h" placeholder="13:50"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- LANCERS -->
      <div id="lancers-content" class="tab-content" data-tab="lancers">
        <form class="calculator-form" id="lancers-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>Poids (m)</label>   <input class="form-input meter-input" id="poids"   placeholder="14,72"></div>
            <div class="form-group"><label>Disque (m)</label>  <input class="form-input meter-input" id="disque"  placeholder="55,30"></div>
            <div class="form-group"><label>Marteau (m)</label> <input class="form-input meter-input" id="marteau" placeholder="72,00"></div>
            <div class="form-group"><label>Javelot (m)</label> <input class="form-input meter-input" id="javelot" placeholder="69,50"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>

      <!-- SAUTS -->
      <div id="sauts-content" class="tab-content" data-tab="sauts">
        <form class="calculator-form" id="sauts-form" novalidate>
          <div class="form-grid">
            <div class="form-group"><label>Hauteur (m)</label>  <input class="form-input meter-input" id="hauteur"  placeholder="1,90"></div>
            <div class="form-group"><label>Perche (m)</label>   <input class="form-input meter-input" id="perche"   placeholder="5,10"></div>
            <div class="form-group"><label>Longueur (m)</label> <input class="form-input meter-input" id="longueur" placeholder="6,42"></div>
            <div class="form-group"><label>Triple (m)</label>   <input class="form-input meter-input" id="triple"   placeholder="13,80"></div>
          </div>
          <button type="submit" class="calculate-btn">Calculer</button>
        </form>
      </div>
    </div>

    <div class="results-container">
      <div class="results-header">
        <h2>Tes rangs</h2>
        <p>Analyse de performance pour chaque épreuve</p>
      </div>
      <div class="rank-grid" id="rankGrid">
        <p class="empty-state">Entre tes performances et calcule ton rang</p>
      </div>
    </div>
  </div>

  <script>
    // ─────────── TABS
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(`${t.dataset.tab}-content`).classList.add('active');
      });
    });

    const rankGrid = document.getElementById('rankGrid');

    // nomenclature des épreuves pour l’affichage
    const NAMES = {
      'demi-fond': {
        '800':'800m','1500':'1500m','3000':'3000m','5000':'5000m',
        '10000':'10 000m','semi':'Semi-marathon','marathon':'Marathon'
      },
      'sprint': {
        t50:'50m', t60:'60m', t100:'100m', t200:'200m', t400:'400m', t50h:'50m H', t60h:'60m H', t110h:'110m H'
      },
      'lancers': {
        poids:'Poids', disque:'Disque', marteau:'Marteau', javelot:'Javelot'
      },
      'sauts': {
        hauteur:'Hauteur', perche:'Perche', longueur:'Longueur', triple:'Triple saut'
      }
    };

    // ─────────── Masques d’entrée
    // Demi-fond : transforme "mmss" -> "mm:ss", puis "hhmmss" -> "hh:mm:ss"
    document.querySelectorAll('.time-input').forEach(input => {
      input.addEventListener('input', e => {
        let v = e.target.value.replace(/[^\d]/g, '');
        if (v.length > 2 && v.length <= 4) v = v.slice(0,2) + ':' + v.slice(2);
        else if (v.length > 4) v = v.slice(0,2) + ':' + v.slice(2,4) + ':' + v.slice(4,6);
        e.target.value = v;
      });
    });
    // Sprint : "ssms" -> "ss:ms"
    document.querySelectorAll('.sprint-input').forEach(input => {
      input.addEventListener('input', e => {
        let v = e.target.value.replace(/[^\d]/g,'');
        if (v.length > 2) v = v.slice(0,2) + ':' + v.slice(2,4);
        e.target.value = v;
      });
    });

    // ─────────── Validations
    function isValidTime(str){
      // mm:ss   ou   hh:mm:ss
      return /^\d{1,2}:\d{2}$/.test(str) || /^\d{1,2}:\d{2}:\d{2}$/.test(str);
    }
    function isValidSprint(str){
      // ss:ms (ms = 1..3)  ou décimal "ss.ms"/"ss,ms"
      return /^\d{1,2}:\d{1,3}$/.test(str) || /^\d{1,2}([.,]\d{1,3})?$/.test(str);
    }
    function isValidMeters(str){
      // "12", "12.3", "12,34"
      return /^\d+([.,]\d+)?$/.test(str.trim());
    }

    // ─────────── Soumission
    document.querySelectorAll('.calculator-form').forEach(form => {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const tab = document.querySelector('.tab.active').dataset.tab;
        await calculate(tab);
      });
    });

    async function calculate(tab){
      const form = document.getElementById(`${tab}-form`);
      const inputs = form.querySelectorAll('.form-input');
      const payload = {};
      let ok = true, hasAny = false;

      inputs.forEach(inp => {
        inp.classList.remove('input-error');
        const v = inp.value.trim();
        if (v==='') return;
        let valid = false;

        if (tab==='demi-fond') valid = isValidTime(v);
        else if (tab==='sprint') valid = isValidSprint(v);
        else valid = isValidMeters(v); // lancers & sauts

        if (!valid) { inp.classList.add('input-error'); ok=false; }
        else { payload[inp.id] = v; hasAny = true; }
      });

      if (!ok){
        rankGrid.innerHTML = '<p class="empty-state error-message">Formats invalides. Utilise hh:mm:ss (demi-fond), ss:ms (sprint), mètres (lancers/sauts).</p>';
        return;
      }
      if (!hasAny){
        rankGrid.innerHTML = '<p class="empty-state">Renseigne au moins une performance.</p>';
        return;
      }

      rankGrid.innerHTML = '<p class="empty-state">Calcul en cours…</p>';
      try {
        const res = await fetch(`https://api-front.riseupmotion.com/calcul/${tab}`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        renderResults(tab, data, payload);
      } catch(err){
        console.error(err);
        rankGrid.innerHTML = '<p class="empty-state error-message">Erreur : impossible de joindre le serveur.</p>';
      }
    }

    function renderResults(tab, data, payload){
      rankGrid.innerHTML = '';
      if (!data.success || !data.results){
        rankGrid.innerHTML = `<p class="empty-state error-message">${data.message || 'Erreur inconnue.'}</p>`;
        return;
      }
      // on parcourt les champs soumis pour conserver l’ordre d’entrée
      Object.keys(payload).forEach(id => {
        const keyForResults = (tab==='demi-fond') ? id.replace('chrono_','') : id; // backend demi-fond renvoie sans "chrono_"
        const res = data.results[keyForResults];
        const label = NAMES[tab][keyForResults] || keyForResults;
        const value = payload[id];

        let badge = '<div class="rank-badge rank-empty">-</div>', cls='rank-card';
        if (res){
          const style = res.hex ? `style="background:${res.hex}"` : '';
          badge = `<div class="rank-badge" ${style}>${res.rang}</div>`;
          cls = 'rank-card filled';
        }
        rankGrid.insertAdjacentHTML('beforeend', `
          <div class="${cls}">
            <div class="event-info">
              <div class="event-name">${label}</div>
              <div class="performance-value">${value}</div>
            </div>
            ${badge}
          </div>
        `);
      });
    }
  </script>
</body>
</html>
